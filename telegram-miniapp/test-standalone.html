<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ElectroService - –¢–µ—Å—Ç Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        .btn:hover {
            background: #0056cc;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç Telegram Mini App</h1>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑ Telegram WebApp</p>

        <button class="btn" onclick="testConnection()">üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase</button>
        <button class="btn" onclick="testAuth()">üîê –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</button>
        <button class="btn" onclick="testData()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button class="btn" onclick="testTasks()">üìã –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É</button>
        <button class="btn" onclick="openApp()">üöÄ –û—Ç–∫—Ä—ã—Ç—å Mini App</button>

        <div id="status"></div>
    </div>

    <script>
        const SUPABASE_URL = 'http://127.0.0.1:54321'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'

        function log(message, type = 'info') {
            const status = document.getElementById('status')
            const div = document.createElement('div')
            div.className = `status ${type}`
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`
            status.appendChild(div)
            status.scrollTop = status.scrollHeight
        }

        async function testConnection() {
            try {
                log('üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase...')

                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                })

                if (response.ok) {
                    log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ!', 'success')
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${response.status}`, 'error')
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error')
            }
        }

        async function testAuth() {
            try {
                log('üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...')

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const response = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({
                        email: 'test.worker@electroservice.by',
                        password: 'telegram_481890'
                    })
                })

                const data = await response.json()

                if (response.ok) {
                    log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω/–Ω–∞–π–¥–µ–Ω: ${data.user?.email}`, 'success')
                    if (data.access_token) {
                        log(`‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${data.access_token.substring(0, 20)}...`, 'success')
                        window.testToken = data.access_token
                    }
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${data.error_description || data.msg}`, 'error')
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error')
            }
        }

        async function testData() {
            try {
                log('üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...')

                const headers = {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${window.testToken || SUPABASE_ANON_KEY}`
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const usersResponse = await fetch(`${SUPABASE_URL}/rest/v1/users`, {
                    headers
                })

                if (usersResponse.ok) {
                    const users = await usersResponse.json()
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`, 'success')
                    users.forEach(user => {
                        log(`   üë§ ${user.email} (${user.role})`, 'info')
                    })
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${usersResponse.status}`, 'error')
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–∞—á–∏
                const tasksResponse = await fetch(`${SUPABASE_URL}/rest/v1/tasks`, {
                    headers
                })

                if (tasksResponse.ok) {
                    const tasks = await tasksResponse.json()
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á: ${tasks.length}`, 'success')
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á: ${tasksResponse.status}`, 'error')
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error')
            }
        }

        async function testTasks() {
            try {
                log('üìã –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∑–∞–¥–∞—á–∏...')

                const headers = {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${window.testToken || SUPABASE_ANON_KEY}`
                }

                // –ü–æ–ª—É—á–∞–µ–º ID —Ä–∞–±–æ—á–µ–≥–æ
                const usersResponse = await fetch(`${SUPABASE_URL}/rest/v1/users?role=eq.worker&select=id,email`, {
                    headers
                })

                if (!usersResponse.ok) {
                    log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—á–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error')
                    return
                }

                const workers = await usersResponse.json()
                if (workers.length === 0) {
                    log('‚ùå –ù–µ—Ç —Ä–∞–±–æ—á–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error')
                    return
                }

                const workerId = workers[0].id
                log(`üë∑ –í—ã–±—Ä–∞–Ω —Ä–∞–±–æ—á–∏–π: ${workers[0].email}`, 'info')

                // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É
                const taskData = {
                    title: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è Telegram Mini App',
                    description: '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è',
                    priority: 'medium',
                    status: 'pending',
                    assigned_to: workerId,
                    created_by: workerId,
                    estimated_hours: 2
                }

                const taskResponse = await fetch(`${SUPABASE_URL}/rest/v1/tasks`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(taskData)
                })

                if (taskResponse.ok) {
                    const task = await taskResponse.json()
                    log(`‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: ${task[0]?.title}`, 'success')
                    log(`   üìã ID –∑–∞–¥–∞—á–∏: ${task[0]?.id}`, 'info')
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏: ${taskResponse.status}`, 'error')
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error')
            }
        }

        function openApp() {
            log('üöÄ –û—Ç–∫—Ä—ã—Ç–∏–µ Mini App...')
            window.open('http://localhost:5175', '_blank')
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üß™ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success')
            log('üì± Telegram WebApp SDK: ' + (window.Telegram?.WebApp ? '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'), 'info')
        })
    </script>
</body>
</html>
